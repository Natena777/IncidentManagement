class IoBoxManager {
    constructor(ioBoxId, inputsId, outputId, executeBtnId, clearBtnId, closeBtnId) {
        this.ioBox = document.getElementById(ioBoxId);
        this.inputsDiv = document.getElementById(inputsId);
        this.output = document.getElementById(outputId);
        this.executeBtn = document.getElementById(executeBtnId);
        this.clearBtn = document.getElementById(clearBtnId);
        this.closeBtn = document.getElementById(closeBtnId);
        
        this.currentAction = null;
        this.actionsConfig = {};
        
        this.initEventListeners();
    }

    initEventListeners() {
        // Clear button
        this.clearBtn.addEventListener("click", () => {
            this.output.innerHTML = "";
        });

        // Close button
        this.closeBtn.addEventListener("click", () => {
            this.ioBox.style.display = "none";
            this.output.innerHTML = "";
        });
    }

    setActionsConfig(config) {
        this.actionsConfig = config;
    }

    attachModuleButtons(selector = ".module-button") {
        document.querySelectorAll(selector).forEach(btn => {
            btn.addEventListener("click", () => {
                const actionKey = btn.dataset.action;
                console.log("Action Key: ", actionKey);
                this.showIoBox(actionKey);
            });
        });
    }

    showIoBox(actionKey) {
        this.currentAction = this.actionsConfig[actionKey];
        if (!this.currentAction) {
            console.error("უცნობი მოქმედება: " + actionKey);
            return;
        }

        this.ioBox.style.display = "block";
        this.inputsDiv.innerHTML = "";

        this.currentAction.inputs.forEach(inp => {
            this.createInputElement(inp);
        });

        this.executeBtn.onclick = () => this.currentAction.execute();
        this.output.innerHTML = "";

        // თუ არსებობს onShow callback, გაუშვი იგი
        if (this.currentAction.onShow && typeof this.currentAction.onShow === 'function') {
            this.currentAction.onShow();
        }
    }

    createInputElement(config) {
        const type = config.type || "text";
        let element;

        switch (type) {
            case "select":
                element = this.createSelect(config);
                break;
            case "textarea":
                element = this.createTextarea(config);
                break;
            case "checkbox":
                element = this.createCheckbox(config);
                break;
            case "radio":
                element = this.createRadio(config);
                break;
            case "date":
            case "email":
            case "number":
            case "password":
            case "text":
            default:
                element = this.createInput(config);
                break;
        }

        this.inputsDiv.appendChild(element);
    }

    createInput(config) {
        const wrapper = document.createElement("div");
        wrapper.style.marginBottom = "12px";

        if (config.label) {
            const label = document.createElement("label");
            label.textContent = config.label;
            label.style.display = "block";
            label.style.marginBottom = "5px";
            label.style.fontWeight = "bold";
            wrapper.appendChild(label);
        }

        const input = document.createElement("input");
        input.type = config.type || "text";
        input.id = config.id;
        input.placeholder = config.placeholder || "";
        input.style.width = "100%";
        input.style.padding = "12px";
        input.style.borderRadius = "8px";
        input.style.border = "1px solid #ccc";
        input.style.fontSize = "15px";

        if (config.value) input.value = config.value;
        if (config.required) input.required = true;

        wrapper.appendChild(input);
        return wrapper;
    }

    createSelect(config) {
        const wrapper = document.createElement("div");
        wrapper.style.marginBottom = "12px";

        if (config.label) {
            const label = document.createElement("label");
            label.textContent = config.label;
            label.style.display = "block";
            label.style.marginBottom = "5px";
            label.style.fontWeight = "bold";
            wrapper.appendChild(label);
        }

        const select = document.createElement("select");
        select.id = config.id;
        select.style.width = "100%";
        select.style.padding = "12px";
        select.style.borderRadius = "8px";
        select.style.border = "1px solid #ccc";
        select.style.fontSize = "15px";

        // პირველი ოფცია (placeholder)
        if (config.placeholder) {
            const placeholderOption = document.createElement("option");
            placeholderOption.value = "";
            placeholderOption.textContent = config.placeholder;
            placeholderOption.disabled = true;
            placeholderOption.selected = true;
            select.appendChild(placeholderOption);
        }

        // ოფციების დამატება
        if (config.options && Array.isArray(config.options)) {
            config.options.forEach(opt => {
                const option = document.createElement("option");
                option.value = opt.value || opt;
                option.textContent = opt.label || opt;
                if (config.value === option.value) option.selected = true;
                select.appendChild(option);
            });
        }

        wrapper.appendChild(select);
        return wrapper;
    }

    createTextarea(config) {
        const wrapper = document.createElement("div");
        wrapper.style.marginBottom = "12px";

        if (config.label) {
            const label = document.createElement("label");
            label.textContent = config.label;
            label.style.display = "block";
            label.style.marginBottom = "5px";
            label.style.fontWeight = "bold";
            wrapper.appendChild(label);
        }

        const textarea = document.createElement("textarea");
        textarea.id = config.id;
        textarea.placeholder = config.placeholder || "";
        textarea.rows = config.rows || 4;
        textarea.style.width = "100%";
        textarea.style.padding = "12px";
        textarea.style.borderRadius = "8px";
        textarea.style.border = "1px solid #ccc";
        textarea.style.fontSize = "15px";
        textarea.style.resize = "vertical";

        if (config.value) textarea.value = config.value;

        wrapper.appendChild(textarea);
        return wrapper;
    }

    createCheckbox(config) {
        const wrapper = document.createElement("div");
        wrapper.style.marginBottom = "12px";
        wrapper.style.display = "flex";
        wrapper.style.alignItems = "center";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.id = config.id;
        checkbox.style.marginRight = "8px";
        checkbox.style.width = "18px";
        checkbox.style.height = "18px";

        if (config.checked) checkbox.checked = true;

        const label = document.createElement("label");
        label.htmlFor = config.id;
        label.textContent = config.label || config.placeholder || "";
        label.style.cursor = "pointer";

        wrapper.appendChild(checkbox);
        wrapper.appendChild(label);
        return wrapper;
    }

    createRadio(config) {
        const wrapper = document.createElement("div");
        wrapper.style.marginBottom = "12px";

        if (config.label) {
            const label = document.createElement("label");
            label.textContent = config.label;
            label.style.display = "block";
            label.style.marginBottom = "8px";
            label.style.fontWeight = "bold";
            wrapper.appendChild(label);
        }

        if (config.options && Array.isArray(config.options)) {
            config.options.forEach(opt => {
                const radioWrapper = document.createElement("div");
                radioWrapper.style.marginBottom = "5px";
                radioWrapper.style.display = "flex";
                radioWrapper.style.alignItems = "center";

                const radio = document.createElement("input");
                radio.type = "radio";
                radio.id = `${config.id}_${opt.value || opt}`;
                radio.name = config.id;
                radio.value = opt.value || opt;
                radio.style.marginRight = "8px";

                if (config.value === radio.value) radio.checked = true;

                const radioLabel = document.createElement("label");
                radioLabel.htmlFor = radio.id;
                radioLabel.textContent = opt.label || opt;
                radioLabel.style.cursor = "pointer";

                radioWrapper.appendChild(radio);
                radioWrapper.appendChild(radioLabel);
                wrapper.appendChild(radioWrapper);
            });
        }

        return wrapper;
    }

    showLoading() {
        this.output.innerHTML = "<p>Loading...</p>";
    }

    showError(message) {
        this.output.innerHTML = `<p style="color:red;font-weight:bold;">Error: ${message}</p>`;
    }

    showSuccess(message) {
        this.output.innerHTML = `<p style="color:green;font-weight:bold;">${message}</p>`;
    }

    renderJSON(data) {
        const pre = document.createElement("pre");
        pre.style.marginTop = "20px";
        pre.style.background = "#f8f8f8";
        pre.style.padding = "15px";
        pre.style.borderRadius = "8px";
        pre.style.border = "1px solid #ddd";
        pre.textContent = JSON.stringify(data, null, 2);
        this.output.appendChild(pre);
    }
}

window.IoBoxManager = IoBoxManager;